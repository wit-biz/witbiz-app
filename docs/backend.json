{
  "entities": {
    "Contact": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Contact",
      "type": "object",
      "description": "Represents a customer contact within the CRM.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Contact entity."
        },
        "name": {
          "type": "string",
          "description": "Full name of the contact or company."
        },
        "email": {
          "type": "string",
          "description": "Email address of the contact.",
          "format": "email"
        },
        "phone": {
          "type": "string",
          "description": "Phone number of the contact."
        },
        "company": {
          "type": "string",
          "description": "Company the contact is associated with."
        },
        "status": {
          "type": "string",
          "enum": ["Activo", "Inactivo"],
          "description": "Current status of the contact."
        }
      },
      "required": [
        "id",
        "name",
        "status"
      ]
    },
    "Lead": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Lead",
      "type": "object",
      "description": "Represents a lead and its progress through the sales pipeline.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Lead entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the lead."
        },
        "status": {
          "type": "string",
          "description": "Current status of the lead (e.g., New, Contacted, Qualified, Opportunity, Customer)."
        },
        "source": {
          "type": "string",
          "description": "Source of the lead (e.g., Website, Referral, Advertisement)."
        },
        "assignedTo": {
          "type": "string",
          "description": "Reference to User. User assigned to the lead. (Relationship: User 1:N Lead)"
        }
      },
      "required": [
        "id",
        "name",
        "status"
      ]
    },
    "Task": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Task",
      "type": "object",
      "description": "Represents a task assigned to a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Task entity."
        },
        "title": {
          "type": "string",
          "description": "Title of the task."
        },
        "description": {
          "type": "string",
          "description": "Description of the task."
        },
        "dueDate": {
          "type": "string",
          "description": "Due date of the task.",
          "format": "date-time"
        },
        "status": {
          "type": "string",
          "description": "Status of the task (e.g., Open, In Progress, Completed)."
        },
        "assignedTo": {
          "type": "string",
          "description": "Reference to User. User assigned to the task. (Relationship: User 1:N Task)"
        },
        "leadId": {
          "type": "string",
          "description": "Reference to Lead. (Relationship: Lead 1:N Task)"
        }
      },
      "required": [
        "id",
        "title",
        "dueDate",
        "status",
        "assignedTo"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the CRM system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "email": {
          "type": "string",
          "description": "Email address of the user.",
          "format": "email"
        },
        "firstName": {
          "type": "string",
          "description": "First name of the user."
        },
        "lastName": {
          "type": "string",
          "description": "Last name of the user."
        }
      },
      "required": [
        "id",
        "email"
      ]
    },
    "Promoter": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Promoter",
      "type": "object",
      "description": "Represents a promoter who refers clients.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Promoter entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the promoter."
        },
        "status": {
          "type": "string",
          "enum": ["Activo", "Inactivo"],
          "description": "Current status of the promoter."
        },
        "referredClients": {
          "type": "number",
          "description": "Number of clients referred by the promoter."
        },
        "totalCommissions": {
          "type": "number",
          "description": "Total commissions earned by the promoter."
        }
      },
      "required": ["id", "name", "status"]
    },
    "Supplier": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Supplier",
      "type": "object",
      "description": "Represents a supplier of goods or services.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Supplier entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the supplier."
        },
        "contact": {
          "type": "string",
          "description": "Contact information for the supplier (e.g., email or phone)."
        },
        "service": {
          "type": "string",
          "description": "The service or product provided by the supplier."
        },
        "promoterId": {
          "type": "string",
          "description": "Optional reference to a promoter who referred this supplier."
        },
        "status": {
          "type": "string",
          "enum": ["Activo", "Inactivo"],
          "description": "Current status of the supplier."
        }
      },
      "required": ["id", "name", "status"]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Collection to store user profiles.  'userId' corresponds to the Firebase Auth UID.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/leads/{leadId}",
        "definition": {
          "entityName": "Lead",
          "schema": {
            "$ref": "#/backend/entities/Lead"
          },
          "description": "Subcollection to store leads owned by a specific user.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the user who owns the lead."
            },
            {
              "name": "leadId",
              "description": "The unique identifier of the lead."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/contacts/{contactId}",
        "definition": {
          "entityName": "Contact",
          "schema": {
            "$ref": "#/backend/entities/Contact"
          },
          "description": "Subcollection to store contacts owned by a specific user.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the user who owns the contact."
            },
            {
              "name": "contactId",
              "description": "The unique identifier of the contact."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/tasks/{taskId}",
        "definition": {
          "entityName": "Task",
          "schema": {
            "$ref": "#/backend/entities/Task"
          },
          "description": "Subcollection to store tasks assigned to a specific user.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the user to whom the task is assigned."
            },
            {
              "name": "taskId",
              "description": "The unique identifier of the task."
            }
          ]
        }
      },
       {
        "path": "/users/{userId}/promoters/{promoterId}",
        "definition": {
          "entityName": "Promoter",
          "schema": {
            "$ref": "#/backend/entities/Promoter"
          },
          "description": "Subcollection to store promoters managed by a specific user.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the user who manages the promoter."
            },
            {
              "name": "promoterId",
              "description": "The unique identifier of the promoter."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/suppliers/{supplierId}",
        "definition": {
          "entityName": "Supplier",
          "schema": {
            "$ref": "#/backend/entities/Supplier"
          },
          "description": "Subcollection to store suppliers managed by a specific user.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Auth UID of the user who manages the supplier."
            },
            {
              "name": "supplierId",
              "description": "The unique identifier of the supplier."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to address the reported permission error and ensure secure and scalable data management for the WitCRM application. The primary principle is Authorization Independence, achieved through denormalization and structural segregation.  The error `Missing or insufficient permissions` on the path `/databases/(default)/documents/users/lbz7nN49aERC4AwnsGSruB6spQJ3/notes` indicates the security rules are not allowing the user to `list` notes.  This structure uses path-based ownership for notes and other user-owned data, resolving the immediate issue and preventing future authorization problems.  \n\n**Authorization Independence:** User-owned entities like `Leads`, `Tasks`, and `Contacts` are stored under user-specific subcollections (e.g., `/users/{userId}/leads/{leadId}`). This structure inherently enforces ownership and eliminates the need for complex `get()` calls in security rules. This avoids hierarchical authorization dependencies, crucial for atomic operations and debuggability.  The security rules can simply check `request.auth.uid == userId`.\n\n**Structural Segregation:**  Data with different access requirements is stored in separate collections. All documents within a collection share the same security posture, simplifying rule definitions. For example, `Leads`, `Tasks`, and `Contacts` are stored under their respective user subcollections, ensuring that only the assigned user can access them.\n\n**QAPs (Rules are not Filters):**  The path-based ownership model enables secure `list` operations. A user can only list the documents within their own `/users/{userId}` subcollections. This directly addresses the error reported, allowing users to list their notes (after the appropriate rules are added, which this data structure facilitates).  \n\n**Invariants:**  The structure supports the integrity of ownership. The `assignedTo` field in `Lead` and `Task` documents is used for relationship purposes, but the actual ownership and access control are enforced by the path structure."
  }
}
