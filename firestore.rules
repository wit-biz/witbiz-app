
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Gets the user's role from their profile document in the /users collection.
     * This is used to grant role-based access.
     */
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    /**
     * Checks if the user's role is 'Director'.
     */
    function isDirector() {
      return isSignedIn() && getUserRole() == 'Director';
    }
    
    /**
     * Checks if the user's role is 'Administrador'.
     */
    function isAdmin() {
      return isSignedIn() && getUserRole() == 'Administrador';
    }
    
    /**
     * Checks if the user is the owner of their own user document.
     */
    function isSelf(userId) {
        return isSignedIn() && request.auth.uid == userId;
    }

    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    match /users/{userId} {
      allow read, update: if isSelf(userId) || isDirector() || isAdmin();
      allow list, create, delete: if isDirector() || isAdmin();
    }
    
    match /clients/{clientId} {
      allow read, write: if isSignedIn();
    }

    match /tasks/{taskId} {
      allow read, write: if isSignedIn();
    }

    match /documents/{documentId} {
      allow read, write: if isSignedIn();
    }

    match /notes/{noteId} {
      allow read, write: if isSignedIn(); 
    }
    
    match /serviceWorkflows/{serviceId} {
        allow read, write: if isSignedIn();
    }
    
    match /promoters/{promoterId} {
        allow read, write: if isSignedIn();
    }
    
    match /suppliers/{supplierId} {
        allow read, write: if isSignedIn();
    }
    
    // --- Accounting collections ---
    // These collections hold configuration data that needs to be readable 
    // by any authenticated user for the app to function correctly.
    // Write access can be restricted if needed in the future based on specific roles.
    match /companies/{companyId} {
        allow read, write: if isSignedIn();
    }
    match /bankAccounts/{accountId} {
        allow read, write: if isSignedIn();
    }
    match /categories/{categoryId} {
        allow read, write: if isSignedIn();
    }
    match /transactions/{transactionId} {
        allow read, write: if isSignedIn();
    }
    match /loans/{loanId} {
        allow read, write: if isSignedIn();
    }
    
    match /logs/{logId} {
        allow read, create: if isSignedIn();
    }
    
    // Chat conversations - users can only access their own conversations
    match /chatConversations/{conversationId} {
        allow read, write: if isSignedIn() && resource.data.userId == request.auth.uid;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
    }
  }
}
