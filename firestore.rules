
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isDirector() {
      return isSignedIn() && request.auth.token.role == 'Director';
    }

    function hasPermission(permission) {
        return isSignedIn() && request.auth.token.permissions[permission] == true;
    }

    // Admins can do anything
    function isAdmin() {
      return isSignedIn() && request.auth.token.role == 'Administrador';
    }

    // Rules for top-level collections
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId || isDirector() || isAdmin();
      allow list, create, delete: if isDirector() || isAdmin();
    }

    match /clients/{clientId} {
      allow read: if hasPermission('clients_view');
      allow create: if hasPermission('clients_create');
      allow update: if hasPermission('clients_edit');
      allow delete: if hasPermission('clients_delete');
    }

    match /tasks/{taskId} {
      allow read: if hasPermission('tasks_view');
      allow create: if hasPermission('tasks_create');
      allow update: if hasPermission('tasks_edit');
      allow delete: if hasPermission('tasks_delete');
    }

    match /documents/{documentId} {
      allow read: if hasPermission('documents_view');
      allow create: if hasPermission('documents_upload');
      allow update: if hasPermission('documents_edit');
      allow delete: if hasPermission('documents_archive');
    }

    match /notes/{noteId} {
      allow read, create, update, delete: if isSignedIn(); // Simplified for collaboration
    }
    
    match /serviceWorkflows/{serviceId} {
        allow read: if hasPermission('services_view');
        allow write: if hasPermission('workflow_edit') || hasPermission('services_edit');
    }
    
    match /promoters/{promoterId} {
        allow read: if hasPermission('promoters_view');
        allow create: if hasPermission('promoters_create');
        allow update: if hasPermission('promoters_edit');
        allow delete: if hasPermission('promoters_delete');
    }
    
    match /suppliers/{supplierId} {
        allow read: if hasPermission('suppliers_view');
        allow create: if hasPermission('suppliers_create');
        allow update: if hasPermission('suppliers_edit');
        allow delete: if hasPermission('suppliers_delete');
    }
    
    // Accounting collections
    match /companies/{companyId} {
        allow read, write: if hasPermission('accounting_config');
    }
    match /bankAccounts/{accountId} {
        allow read, write: if hasPermission('accounting_config');
    }
    match /categories/{categoryId} {
        allow read, write: if hasPermission('accounting_config');
    }
    match /transactions/{transactionId} {
        allow read: if hasPermission('accounting_view');
        allow write: if hasPermission('accounting_view');
    }
    match /loans/{loanId} {
        allow read: if hasPermission('accounting_view');
        allow write: if hasPermission('accounting_view');
    }
    
    match /logs/{logId} {
        allow read, create: if isSignedIn();
    }
  }
}
