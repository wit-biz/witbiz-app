/**
 * This ruleset enforces a strict user-ownership model for a CRM application.
 * It is designed for rapid prototyping, focusing on strong authorization while
 * maintaining flexibility in data schemas.
 *
 * Core Philosophy:
 * A user has complete control over their own data, and no access to anyone else's.
 * All operations require a user to be authenticated. There is no public data.
 *
 * Data Structure:
 * All application data is hierarchically nested under a user-specific path:
 * /users/{userId}/...
 * This structure makes ownership clear and security rules efficient, as authorization
 * can be determined directly from the document path without needing extra database reads.
 *
 * Key Security Decisions:
 * - User Isolation: All rules are scoped to the authenticated user's UID (`request.auth.uid`).
 * - No User Listing: It is forbidden to list the top-level `/users` collection to prevent
 *   data scraping and enumeration of all application users.
 * - Path-Based Security: Ownership is derived from the `{userId}` wildcard in the path,
 *   which is the most performant and secure way to handle user-owned data.
 * - Relational Integrity: On document creation, key identifiers (like `userId`, `clientId`)
 *   are validated to ensure they match the document's path, preventing data from being
 *   misfiled. These identifiers are immutable once created.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    //-------------------------------------------------------------------------
    //  Helper Functions
    //-------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the primary function for verifying document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document. Used for update and delete
     * operations to prevent acting on documents that don't exist.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    // --- Create Operation Validation ---

    /**
     * Validates that the new User document contains an `id` field that
     * matches the user's auth UID.
     */
    function hasValidUserDataForCreate(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * Validates that the new Client document's `id` matches the document ID.
     */
    function hasValidClientDataForCreate(clientId) {
      return request.resource.data.id == clientId;
    }

    /**
     * Validates that the new Lead document's IDs match their respective path segments.
     */
    function hasValidLeadDataForCreate(clientId, leadId) {
      return request.resource.data.id == leadId
          && request.resource.data.clientId == clientId;
    }

    /**
     * Validates that the new Task document's IDs correctly reference its owner and parent lead.
     * This is critical for maintaining relational integrity.
     */
    function hasValidTaskDataForCreate(userId, leadId, taskId) {
      return request.resource.data.id == taskId
          && request.resource.data.leadId == leadId
          && request.resource.data.userId == userId;
    }

    /**
     * Placeholder for Note creation validation. Currently allows any data as long as user is owner.
     */
    function hasValidNoteDataForCreate() {
        return true;
    }

    // --- Update Operation Validation ---

    /**
     * Enforces immutability for the User's unique ID.
     */
    function hasImmutableUserFields() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Enforces immutability for the Client's unique ID.
     */
    function hasImmutableClientFields() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Enforces immutability for the Lead's relational IDs.
     */
    function hasImmutableLeadFields() {
      return request.resource.data.id == resource.data.id
          && request.resource.data.clientId == resource.data.clientId;
    }

    /**
     * Enforces immutability for the Task's relational IDs.
     */
    function hasImmutableTaskFields() {
      return request.resource.data.id == resource.data.id
          && request.resource.data.leadId == resource.data.leadId
          && request.resource.data.userId == resource.data.userId;
    }

    /**
     * Placeholder for Note update validation. Currently allows any updates.
     */
    function hasValidNoteDataForUpdate() {
      return request.resource.data.clientId == resource.data.clientId;
    }


    //-------------------------------------------------------------------------
    //  Collection Rules
    //-------------------------------------------------------------------------

    /**
     * @description Manages user profile documents.
     * @path /users/{userId}
     * @allow (get) A user can read their own profile.
     * @allow (create) An authenticated user can create their own profile document.
     * @deny (list) No one can list all users in the system.
     * @deny (update) An authenticated user cannot update another user's profile.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && hasValidUserDataForCreate(userId);
      allow update: if isExistingOwner(userId) && hasImmutableUserFields();
      allow delete: if isExistingOwner(userId);

      /**
       * @description Manages a user's clients.
       * @path /users/{userId}/clients/{clientId}
       * @allow (create, list) A user can create and list their own clients.
       * @deny (get) A user cannot read another user's clients.
       * @principle Enforces document ownership for all operations within a user's private subcollection.
       */
      match /clients/{clientId} {
        allow get, list, create, update, delete: if isOwner(userId);

        /**
         * @description Manages leads associated with a specific contact.
         * @path /users/{userId}/clients/{clientId}/leads/{leadId}
         * @allow (create, list) A user can create and list leads for their own contacts.
         * @deny (get) A user cannot read another user's leads.
         * @principle Enforces document ownership, inheriting access control from the parent user path.
         */
        match /leads/{leadId} {
          allow get, list, create, update, delete: if isOwner(userId);

          /**
           * @description Manages tasks associated with a specific lead.
           * @path /users/{userId}/clients/{clientId}/leads/{leadId}/tasks/{taskId}
           * @allow (create) A user can create a task.
           * @deny (delete) A user cannot delete tasks belonging to another user.
           * @principle Validates relational integrity by ensuring the task's internal `userId` matches the path.
           */
          match /tasks/{taskId} {
            allow get, list, create, update, delete: if isOwner(userId);
          }
        }
      }
      
      /**
       * @description Manages documents associated with a specific user.
       * @path /users/{userId}/documents/{documentId}
       */
      match /documents/{documentId} {
          allow get, list, create, update, delete: if isOwner(userId);
      }
      
      /**
       * @description Manages service workflows templates for a user.
       * @path /users/{userId}/serviceWorkflows/{serviceId}
       */
      match /serviceWorkflows/{serviceId} {
          allow get, list, create, update, delete: if isOwner(userId);
      }

      /**
       * @description Manages promoters for a user.
       * @path /users/{userId}/promoters/{promoterId}
       */
       match /promoters/{promoterId} {
          allow get, list, create, update, delete: if isOwner(userId);
       }
       
      /**
       * @description Manages suppliers for a user.
       * @path /users/{userId}/suppliers/{supplierId}
       */
       match /suppliers/{supplierId} {
            allow get, list, create, update, delete: if isOwner(userId);
       }

      /**
       * @description Manages notes for a user.
       * @path /users/{userId}/notes/{noteId}
       */
       match /notes/{noteId} {
            allow get, list, create, update, delete: if isOwner(userId);
       }
    }
  }
}
