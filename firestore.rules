/**
 * @description This ruleset enforces a strict user-ownership model for leads, contacts, and tasks.
 * All data is nested under /users/{userId}, ensuring that only the authenticated user can access their own data.
 *
 * @data_structure
 * - /users/{userId}/leads/{leadId}: Stores leads owned by a specific user.
 * - /users/{userId}/contacts/{contactId}: Stores contacts owned by a specific user.
 * - /users/{userId}/tasks/{taskId}: Stores tasks assigned to a specific user.
 *
 * @key_security_decisions
 * - User listing is disallowed.
 * - Read-only collections are not present.
 * - Ambiguous relationships default to strict owner-only access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces user-ownership for leads, allowing users to manage their own leads.
     * @path /users/{userId}/leads/{leadId}
     * @allow (create) User 'lbz7nN49aERC4AwnsGSruB6spQJ3' can create a lead with ID 'lead123' under /users/lbz7nN49aERC4AwnsGSruB6spQJ3/leads/lead123.
     * @allow (update) User 'lbz7nN49aERC4AwnsGSruB6spQJ3' can update a lead with ID 'lead123' under /users/lbz7nN49aERC4AwnsGSruB6spQJ3/leads/lead123.
     * @allow (delete) User 'lbz7nN49aERC4AwnsGSruB6spQJ3' can delete a lead with ID 'lead123' under /users/lbz7nN49aERC4AwnsGSruB6spQJ3/leads/lead123.
     * @deny (create) User 'otherUser' cannot create a lead under /users/lbz7nN49aERC4AwnsGSruB6spQJ3/leads/lead123.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/leads/{leadId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == leadId;
      allow update: if isSignedIn() && isExistingOwner(userId) && isLeadIdNotChanged(leadId);
      allow delete: if isSignedIn() && isExistingOwner(userId);

      function isLeadIdNotChanged(leadId) {
        return request.resource.data.id == leadId;
      }
    }

    /**
     * @description Enforces user-ownership for contacts, allowing users to manage their own contacts.
     * @path /users/{userId}/contacts/{contactId}
     * @allow (create) User 'lbz7nN49aERC4AwnsGSruB6spQJ3' can create a contact with ID 'contact123' under /users/lbz7nN49aERC4AwnsGSruB6spQJ3/contacts/contact123.
     * @allow (update) User 'lbz7nN49aERC4AwnsGSruB6spQJ3' can update a contact with ID 'contact123' under /users/lbz7nN49aERC4AwnsGSruB6spQJ3/contacts/contact123.
     * @allow (delete) User 'lbz7nN49aERC4AwnsGSruB6spQJ3' can delete a contact with ID 'contact123' under /users/lbz7nN49aERC4AwnsGSruB6spQJ3/contacts/contact123.
     * @deny (create) User 'otherUser' cannot create a contact under /users/lbz7nN49aERC4AwnsGSruB6spQJ3/contacts/contact123.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/contacts/{contactId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == contactId;
      allow update: if isSignedIn() && isExistingOwner(userId) && isContactIdNotChanged(contactId);
      allow delete: if isSignedIn() && isExistingOwner(userId);

      function isContactIdNotChanged(contactId) {
        return request.resource.data.id == contactId;
      }
    }

    /**
     * @description Enforces user-ownership for tasks, allowing users to manage their own tasks.
     * @path /users/{userId}/tasks/{taskId}
     * @allow (create) User 'lbz7nN49aERC4AwnsGSruB6spQJ3' can create a task with ID 'task123' under /users/lbz7nN49aERC4AwnsGSruB6spQJ3/tasks/task123.
     * @allow (update) User 'lbz7nN49aERC4AwnsGSruB6spQJ3' can update a task with ID 'task123' under /users/lbz7nN49aERC4AwnsGSruB6spQJ3/tasks/task123.
     * @allow (delete) User 'lbz7nN49aERC4AwnsGSruB6spQJ3' can delete a task with ID 'task123' under /users/lbz7nN49aERC4AwnsGSruB6spQJ3/tasks/task123.
     * @deny (create) User 'otherUser' cannot create a task under /users/lbz7nN49aERC4AwnsGSruB6spQJ3/tasks/task123.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/tasks/{taskId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == taskId;
      allow update: if isSignedIn() && isExistingOwner(userId) && isTaskIdNotChanged(taskId);
      allow delete: if isSignedIn() && isExistingOwner(userId);

      function isTaskIdNotChanged(taskId) {
        return request.resource.data.id == taskId;
      }
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
  }
}